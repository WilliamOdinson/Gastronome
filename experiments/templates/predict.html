{# api/templates/experiment_review_predict.html #}
{% extends "common/base.html" %}

{% block title %}Judge{% endblock %}

{% block content %}
<main class="pattern">
  <div class="wrapper">
    <div class="container margin_80_55">

      <div class="row justify-content-center">
        <div class="col-lg-8">

          <div class="text-center mb-5">
            <h1 class="mb-3">
              <i class="material-icons text-primary align-middle me-1 fs-2">science</i>
              Review Star-Rating Predictor: Judge
            </h1>
            <p class="lead">
              This page presents a <strong>fine-tuned DistilBERT model</strong>
              trained on over two million Yelp restaurant reviews to predict the
              <em>1-to-5 star rating</em> directly from free-text input. The
              model is optimized for natural language understanding and achieves
              over <strong>75% accuracy</strong> on unseen data. It captures
              sentiment and intent beyond surface-level keywords. Enter any
              review below to see how the model interprets it. The predicted
              score will be blended with the user's original rating using a
              tunable weighted average to flag <strong>inconsistent, overly harsh, 
              or unusually positive feedback</strong>.
            </p>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">

              <form id="predictForm" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                  <label for="review" class="form-label">Paste or type your review</label>
                  <textarea id="review"
                            name="review"
                            rows="5"
                            class="form-control"
                            placeholder="e.g. &quot;The service was quick and the tacos were delicious!&quot;"></textarea>
                </div>

                <button type="submit" class="btn_1">
                  <i class="material-icons align-middle me-1">psychology_alt</i>
                  Predict rating
                </button>
              </form>

              <hr class="my-4">

              <div id="result" class="fs-5 text-center"></div>

            </div>
          </div>

          <p class="text-muted small mt-4">
            Model: DistilBERT fine-tuned on Yelp open dataset. Predictions are best-guess and may deviate from human perception.
          </p>

        </div>
      </div>

    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function getCookie (name) {
  const m = document.cookie.match(new RegExp('(^|;\\s*)' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[2]) : null;
}

document.getElementById('predictForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const text = document.getElementById('review').value.trim();
  const $result = document.getElementById('result');
  if (!text) {
    $result.className = 'text-danger';
    $result.textContent = 'Please enter some review text.';
    return;
  }

  $result.className = 'text-muted';
  $result.textContent = 'Predicting ...';

  fetch("{% url 'api:predict_review_api' %}", {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ review: text })
  })
  .then(r => r.json())
  .then(data => {
    if (data.prediction !== undefined) {
      $result.className = 'fw-bold text-success';
      $result.textContent = `Predicted star rating: ${data.prediction} â˜…`;
    } else {
      $result.className = 'text-danger';
      $result.textContent = 'Error: ' + (data.error || 'Unknown');
    }
  })
  .catch(err => {
    console.error(err);
    $result.className = 'text-danger';
    $result.textContent = 'Request failed, please try again later.';
  });
});
</script>
{% endblock %}
