{% extends "common/base.html" %}

{% load static %}

{% block title %}Register{% endblock %}

{% block signin_modal %}{% endblock %}

{% block content %}
<main class="pattern">
  <div class="wrapper">
    <div class="container margin_80_55">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <div class="main_title_2">
            <span><em></em></span>
            <h2>Create account</h2>
          </div>

          {% if error %}
            <p class="text-danger">{{ error }}</p>
          {% endif %}

          <form method="post" novalidate>
            {% csrf_token %}

            <!-- Display name -->
            <div class="mb-3">
              <label for="display_name" class="form-label">Display name</label>
              <input type="text"
                     class="form-control required"
                     id="display_name"
                     name="display_name"
                     required>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email"
                     class="form-control required"
                     id="email"
                     name="email"
                     required>
            </div>

            <!-- Password 1 -->
            <div class="mb-3">
              <label for="password1" class="form-label">Password</label>
              <div class="position-relative">
                <input type="password"
                       class="form-control pe-5 required"
                       id="password1"
                       name="password1"
                       autocomplete="new-password"
                       required>
                <button type="button"
                        class="toggle-password"
                        data-target="#password1"
                        aria-label="Show/Hide password">
                  <i class="material-icons align-middle">visibility_off</i>
                </button>
              </div>
            </div>

            <!-- Password 2 -->
            <div class="mb-3">
              <label for="password2" class="form-label">Confirm password</label>
              <div class="position-relative">
                <input type="password"
                       class="form-control pe-5 required"
                       id="password2"
                       name="password2"
                       autocomplete="new-password"
                       required>
                <button type="button"
                        class="toggle-password"
                        data-target="#password2"
                        aria-label="Show/Hide password">
                  <i class="material-icons align-middle">visibility_off</i>
                </button>
              </div>
            </div>

            <!-- Strength / Match Info -->
            <div id="pass-info" class="clearfix mb-3"></div>

            <!-- Captcha -->
            <div class="mb-4">
              <label class="form-label">Captcha</label>
              <div class="captcha-wrapper">
                <img id="captchaImg"
                     width="140"
                     height="60"
                     alt="captcha"
                     class="shadow-sm rounded">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm ms-2"
                        onclick="refreshCaptcha()"
                        aria-label="Refresh captcha">
                  <i class="material-icons fs-6">refresh</i>
                </button>
              </div>
              <input type="text"
                     class="form-control mt-2 required"
                     name="captcha"
                     placeholder="Enter code"
                     required>
            </div>

            <button type="submit" class="btn_1 full-width">Register</button>
          </form>

          <p class="mt-3 text-center">
            Already have an account?
            <a href="{% url 'user:login' %}">Login here</a>.
          </p>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
/* ---------- Captcha ---------- */
function refreshCaptcha () {
  const ts = Date.now();
  document.getElementById('captchaImg').src =
    "{% url 'api:get_captcha' %}?t=" + ts;
}
document.addEventListener('DOMContentLoaded', refreshCaptcha);

$(document).on('click', '.toggle-password', function () {
  const $btn   = $(this);
  const $icon  = $btn.children('i');
  const $input = $($btn.data('target'));

  const hidden = $input.attr('type') === 'password';
  $input.attr('type', hidden ? 'text' : 'password');
  $icon.text(hidden ? 'visibility' : 'visibility_off');
});

$(function () {
  const p1 = $('#password1');
  const p2 = $('#password2');
  const info = $('#pass-info');
  passwordStrengthCheck(p1, p2, info);
});

function passwordStrengthCheck(password1, password2, passwordsInfo) {
  const WeakPass     = /(?=.{5,}).*/;
  const MediumPass   = /^(?=\S*?[a-z])(?=\S*?[0-9])\S{5,}$/;
  const StrongPass   = /^(?=\S*?[A-Z])(?=\S*?[a-z])(?=\S*?[0-9])\S{5,}$/;
  const VryStrongPass= /^(?=\S*?[A-Z])(?=\S*?[a-z])(?=\S*?[0-9])(?=\S*?[^\w\*])\S{5,}$/;

  password1.on('keyup', () => {
    const val = password1.val();
    if (VryStrongPass.test(val)) {
      passwordsInfo.attr('class','vrystrongpass')
                   .html("Very Strong! (Awesome, don't forget it)");
    } else if (StrongPass.test(val)) {
      passwordsInfo.attr('class','strongpass')
                   .html("Strong! (Add special chars for even better)");
    } else if (MediumPass.test(val)) {
      passwordsInfo.attr('class','goodpass')
                   .html("Good! (Add uppercase for strong)");
    } else if (WeakPass.test(val)) {
      passwordsInfo.attr('class','stillweakpass')
                   .html("Still Weak! (Add digits)");
    } else {
      passwordsInfo.attr('class','weakpass')
                   .html("Very Weak! (â‰¥5 chars)");
    }
  });

  password2.on('keyup', () => {
    passwordsInfo.attr('class',
      password1.val() === password2.val() ? 'goodpass' : 'weakpass')
      .html(password1.val() === password2.val()
        ? "Passwords match!"
        : "Passwords do not match!");
  });
}
</script>
{% endblock %}
